---
output:
  # word_document:
  #   reference_docx: default_gdoc.docx
  #   df_print: kable
  # html_document:
  #   df_print: kable
  pdf_document: 
    df_print: kable
csl: ecology.csl
bibliography: refs.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, include = T, results = T, message = F, warning = F, eval = T, fig.dim = c(4,4))
library(dplyr)
library(drake)
library(multipanelfigure)
library(ggplot2)
theme_set(theme_bw())

## Set up the cache and config
db <- DBI::dbConnect(RSQLite::SQLite(), here::here("analyses", "caches", "all_hasty_toy.sqlite"))
cache <- storr::storr_dbi("datatable", "keystable", db)
cache$del(key = "lock", namespace = "session")


loadd(all_preds, cache=cache)
loadd(all_aics, cache=cache)

winning_aics <- all_aics %>%
  filter(model_family == "Gamma") %>%
  group_by(matssname, model_family) %>%
  mutate(minAICc = min(model_AICc)) %>%
  mutate(deltaAICc = minAICc - model_AICc)  %>%
  mutate(exp_deltas = exp(.5 * deltaAICc)) %>%
  mutate(denom = sum(exp_deltas)) %>%
  mutate(aicc_wt = exp_deltas/ denom) %>%
  arrange(desc(aicc_wt)) %>%
  mutate(rank =row_number()) %>%
  ungroup() %>%
  arrange(matssname, model_family, rank)

delta_2 <- winning_aics %>% filter(deltaAICc > -2) %>%
  filter(model_family == "Gamma") %>%
  group_by(matssname, model_family) %>%
  arrange(modelcomplexity) %>%
  mutate(rank = row_number()) %>%
  filter(rank == 1) %>%
  ungroup()


winning_fits <- delta_2 %>%
  left_join(all_preds) 
```

# Abundance-driven vs. actual change

```{r, fig.dim = c(6,2)}

loadd(all_sims, cache=cache)
rn <- "bbs_rtrg_28_4"
dat <- readd(rn, character_only = T, cache=cache)
source(here::here("analyses", "fxns", "hasty_fxns.R"))

dat_sliced <- slice_dat(dat)
dat_resp <- resp_dat(dat_sliced)

dat_isd <- simulate_isd_ts(dat_sliced, isd_seed = 1989)
dat_resp_isd <- simulate_isd_ts(dat_resp, isd_seed = 1989)

years <- unique(dat_sliced$covariates$year)

begin_years <- years[1:5]
end_years <- years[(length(years) - 4):length(years)]

begin_isd_real <- filter(dat_isd$isd, year %in% begin_years)
end_isd_real <- filter(dat_isd$isd, year %in% end_years )

begin_isd_sim <- filter(dat_resp_isd$isd, year %in% begin_years)
end_isd_sim <- filter(dat_resp_isd$isd, year %in% end_years)

begin_isd_gmm_real <- add_gmm(begin_isd_real) %>%
  mutate(time = "begin")
end_isd_gmm_real <- add_gmm(end_isd_real) %>%
  mutate(time = "end")

real_gmms <- bind_rows(begin_isd_gmm_real, end_isd_gmm_real)

begin_isd_gmm_sim <- add_gmm(begin_isd_sim) %>%
  mutate(time = "begin")
end_isd_gmm_sim <- add_gmm(end_isd_sim)  %>%
  mutate(time = "end")
sim_gmms <- bind_rows(begin_isd_gmm_sim, end_isd_gmm_sim) 


real_isd_plots <- ggplot(real_gmms, aes(mass, density, color = time)) + geom_line() + ggtitle("Observed ISD change")

sim_isd_plots <- ggplot(sim_gmms, aes(mass, density, color = time)) + geom_line() + ggtitle("Null model (long term mean)")


isd_panels <- multi_panel_figure(columns = 2, rows = 1) %>%
  fill_panel(real_isd_plots) %>%
  fill_panel(sim_isd_plots)
isd_panels


dat_dynamics <- filter(all_sims, matssname == rn)

dat_glm <- glm(total_biomass ~ timeperiod * source, data = dat_dynamics, family = Gamma)

dat_dynamics <- dat_dynamics %>%
  mutate(fitted = predict(dat_glm, type = "response"))

timeseries_plot <- ggplot(dat_dynamics, aes(timeperiod, total_biomass, color = source)) + geom_point() + geom_line() + geom_line(aes(y = fitted)) + geom_rect(aes(xmin = years[1], xmax = years[5], ymin = min(total_biomass), ymax = max(total_biomass)), alpha = 0, linetype = 3, color = "black")+ geom_rect(aes(xmin = years[length(years) - 4], xmax = years[length(years)], ymin = min(total_biomass), ymax = max(total_biomass)), alpha = 0, linetype = 3, color = "black")

timeseries_plot
```


# Biomass

## Model outcomes

Overall proportion of routes with winning models:

```{r, results =T}

winning_fits %>% group_by(model_family, model_formula) %>% tally() %>%
  mutate(prop = n / sum(n))

```

Of models with slope term, the proportion for which abundance and biomass are increasing:

```{r}
slope_winning_fits <- winning_fits %>%
  filter(modelcomplexity > 1)

interaction_winning_fits <- winning_fits %>%
  filter(modelcomplexity > 2)

slope_winning_fits %>%
  mutate(abundance_increasing = ratio_sim > 1) %>%
  group_by(abundance_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))


slope_winning_fits %>%
  mutate(biomass_increasing = ratio_real > 1) %>%
  group_by(biomass_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))
```


Restricted to models with an *interaction*:

```{r}
interaction_winning_fits %>%
  mutate(abundance_increasing = ratio_sim > 1) %>%
  group_by(abundance_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))


interaction_winning_fits %>%
  mutate(biomass_increasing = ratio_real > 1) %>%
  group_by(biomass_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))

```

## Direction and magnitude of slopes

```{r}
ggplot(slope_winning_fits, aes(ratio_sim)) + geom_histogram() + scale_x_log10() + geom_vline(xintercept = 1) + ggtitle("Abundance-driven (null model) slope")

```

```{r}
ggplot(slope_winning_fits, aes(ratio_real)) + geom_histogram() + scale_x_log10() + geom_vline(xintercept = 1) + ggtitle("Observed slope")

```

## Direction of decoupling

```{r, fig.dim= c(4,4)}

interaction_all_fits <- all_preds %>% group_by_all() %>% filter( grepl( "* source",model_formula), model_family == "Gamma") %>% mutate(plus = substr(model_formula, 12,12) == "+") %>% filter(!plus) %>% ungroup() %>%
  left_join(select(winning_fits, matssname, model_formula) %>% rename(winning_formula = model_formula))

ggplot(interaction_all_fits, aes(ratio_sim, ratio_real)) + geom_point(alpha = .2) + geom_point(data = filter(interaction_all_fits, winning_formula != "1"), aes(color = winning_formula), alpha = .5) + scale_y_log10() + scale_x_log10() + scale_color_viridis_d(end = .8) + theme(legend.position = "bottom") + geom_abline(intercept = 0, slope = 1) + geom_vline(xintercept = 1) + geom_hline(yintercept = 1)

```
\newpage
# Energy use 
```{r}
loadd(all_preds_energy, cache=cache)
loadd(all_aics_energy, cache=cache)

winning_aics_energy <- all_aics_energy %>%
  filter(model_family == "Gamma") %>%
  group_by(matssname, model_family) %>%
  mutate(minAICc = min(model_AICc)) %>%
  mutate(deltaAICc = minAICc - model_AICc)  %>%
  mutate(exp_deltas = exp(.5 * deltaAICc)) %>%
  mutate(denom = sum(exp_deltas)) %>%
  mutate(aicc_wt = exp_deltas/ denom) %>%
  arrange(desc(aicc_wt)) %>%
  mutate(rank =row_number()) %>%
  ungroup() %>%
  arrange(matssname, model_family, rank)

delta_2_energy <- winning_aics_energy %>% filter(deltaAICc > -2) %>%
  filter(model_family == "Gamma") %>%
  group_by(matssname, model_family) %>%
  arrange(modelcomplexity) %>%
  mutate(rank = row_number()) %>%
  filter(rank == 1) %>%
  ungroup()


winning_fits_energy <- delta_2_energy %>%
  left_join(all_preds_energy) 
```


## Model outcomes

Overall proportion of routes with winning models:

```{r, results =T}

winning_fits_energy %>% group_by(model_family, model_formula) %>% tally() %>%
  mutate(prop = n / sum(n))

```

Of models with slope term, the proportion for which abundance and biomass are increasing:

```{r}
slope_winning_fits_energy <- winning_fits_energy %>%
  filter(modelcomplexity > 1)

interaction_winning_fits_energy <- winning_fits_energy %>%
  filter(modelcomplexity > 2)

slope_winning_fits_energy %>%
  mutate(abundance_increasing = ratio_sim > 1) %>%
  group_by(abundance_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))


slope_winning_fits_energy %>%
  mutate(energy_increasing = ratio_real > 1) %>%
  group_by(energy_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))
```


Restricted to models with an *interaction*:

```{r}
interaction_winning_fits_energy %>%
  mutate(abundance_increasing = ratio_sim > 1) %>%
  group_by(abundance_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))


interaction_winning_fits_energy %>%
  mutate(energy_increasing = ratio_real > 1) %>%
  group_by(energy_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))

```

## Direction and magnitude of slopes

```{r}
ggplot(slope_winning_fits_energy, aes(ratio_sim)) + geom_histogram() + scale_x_log10() + geom_vline(xintercept = 1) + ggtitle("Abundance-driven (null model) slope")
```

```{r}

ggplot(slope_winning_fits_energy, aes(ratio_real)) + geom_histogram() + scale_x_log10() + geom_vline(xintercept = 1) + ggtitle("Observed slope")

```

## Direction of decoupling

```{r, fig.dim= c(4,4)}

interaction_all_fits_energy <- all_preds_energy %>% group_by_all() %>% filter( grepl( "* source",model_formula), model_family == "Gamma") %>% mutate(plus = substr(model_formula, 12,12) == "+") %>% filter(!plus) %>% ungroup() %>%
  left_join(select(winning_fits_energy, matssname, model_formula) %>% rename(winning_formula = model_formula))

ggplot(interaction_all_fits_energy, aes(ratio_sim, ratio_real)) + geom_point(alpha = .2) + geom_point(data = filter(interaction_all_fits_energy, winning_formula != "1"), aes(color = winning_formula), alpha = .5) + scale_y_log10() + scale_x_log10() + scale_color_viridis_d(end = .8) + theme(legend.position = "bottom") + geom_abline(intercept = 0, slope = 1) + geom_vline(xintercept = 1) + geom_hline(yintercept = 1)

```

## Change in mean body size

```{r}

loadd(all_isd_compares, cache =cache)

winning_fits <- winning_fits %>% left_join(all_isd_compares)


ggplot(winning_fits, aes(real_mass_ratio, color = model_formula, fill= model_formula)) + geom_histogram() + facet_wrap(vars(model_formula), scales = 'free_y', ncol = 1)


```

## ISD overlap

```{r}


ggplot(winning_fits, aes(real_overlap, color = model_formula, fill = model_formula)) + geom_histogram() + facet_wrap(vars(model_formula), scales = 'free_y', ncol = 1)

isd_glm <- glm(real_overlap ~ model_formula, family = "binomial", data = winning_fits)
# 
# AIC(isd_glm)
# AIC(glm(real_overlap ~ 1, family = "binomial", data = winning_fits))

glm_cor <- cor(predict(isd_glm, type = "response"), isd_glm$model[,1]) ^ 2
```

R2 of binomial GLM `overlap ~ model_formula` (which does not beat a `overlap ~ 1` via AIC, FYI)

```{r}
glm_cor
```

# Goodness of fit of models

```{r}

ggplot(winning_fits, aes(model_cor_squared)) + geom_histogram() + facet_wrap(vars(model_formula), scales = "free_y")

ggplot(winning_fits_energy, aes(model_cor_squared)) + geom_histogram() + facet_wrap(vars(model_formula), scales = "free_y")

```


##
\newpage
# References
