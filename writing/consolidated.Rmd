---
output:
  pdf_document: 
    df_print: kable
  # html_document:
  #   df_print: kable
  # word_document:
  #   reference_docx: default_gdoc.docx
  #   df_print: kable
csl: ecology.csl
bibliography: refs.bib
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, include = T, results = T, message = F, warning = F, eval = T, fig.dim = c(4,4))
library(dplyr)
library(drake)
library(multipanelfigure)
library(ggplot2)
theme_set(theme_bw())

## Set up the cache and config
db <- DBI::dbConnect(RSQLite::SQLite(), here::here("analyses", "caches", "all_hasty_toy.sqlite"))
cache <- storr::storr_dbi("datatable", "keystable", db)
cache$del(key = "lock", namespace = "session")


```
# Introduction

Understanding the interrelated dynamics of size- and -abundance based dimensions of biodiversity is key to understanding biodiversity change in the Anthropocene. Total abundance - i.e. the total number of individual organisms present in a system - and size-based currencies, such as the total biomass or total metabolic flux (“energy use”) of a system, are intertwined, but nonequivalent, measures of biological function. Abundance is more closely tied to species-level population dynamics, while size-based metrics more directly reflect assemblage-level resource use and contributions to materials fluxes at the broader ecosystem scale [@morlon2009; @dornelas2011; @white2007; @connolly2005]. While these currencies are naturally linked [@henderson2010; @morlon2009], changes in size composition can decouple the dynamics of one currency from another [@dornelas2011; @white2004; @white2007; @ernest2009; @yen2017]. This can mean that intuition from one currency may be misleading about others; a trend in numerical abundance might mask something else going on with biomass [@white2004]. Changes in size composition strong enough to decouple currencies may be symptomatic of important changes in ecosystem status- e.g. abundance-biomass comparison curves [@petchey2010]; size-biased extinctions [@young2016; @smith2018]. This underscores the need to understand how these dynamics are playing out in the Anthropocene [@fisher2010]. 


At the **community scale**, changes in the relationship between size and abundance tells us about important functional shifts. This is the scale at which ecological processes (i.e. compensatory dynamics, niche tracking, functional replacement) come into play - in contrast to population or global trends [@mcgill2015; @dornelas2014; @white2007]. To the extent that size is a proxy for other functional traits, changes or consistency in the community-level size structure (individiual size distribution, ISD) over time may reflect processes related to niche structure [@white2007; @petchey2010]. Strong size shifts can decouple the relationship between abundance and biomass. In aquatic systems, such changes in the scaling between abundance and biomass often signal ecosystem degradation [@petchey2010; @kerr01; @warwick1994 and refs therein]. Compensatory shifts in the size structure can buffer community function (in terms of biomass or energy use) against changes in abundance [@terry2015; @ernest2009; @white2004]. Consistency in the size structure may maintain the relationship between size- and -abundance based currencies, even as species composition, total abundance, and total biomass/total energy use fluctuate over time, which can reflect consistency in the niche structure over time [@holling1992]. 


It is important to improve our understanding of these dynamics for terrestrial animal communities in particular. In contrast to terrestrial trees and aquatic systems [@kerr01; @white2007], how the relationship between size and abundance changes over time, and the consequences of these changes for ecosystem-level properties, remain relatively unknown for terrestrial animals (but see @white2004). Terrestrial animal communities exhibit size structure [@ernest2005; @thibault2011], and case studies have demonstrated that size shifts can either decouple N from E for terrestrial animals [@white2004; @yen2017], but not always [@hernandez2011]. Establishing generalities in these dynamics is especially pertinent in the Anthropocene, as these communities are experiencing extensive and potentially size-structured change, with implications at community, ecosystem, and global scales [@young2016; @schmitz2018].

Macroecological-scale synthesis on the interrelated dynamics of the ISD, total abundance, and community function for terrestrial animals has been constrained by 1) a lack of community-level size and abundance timeseries data for these systems [@white2007; @thibault2011], and 2) appropriate statistical methods for relating change in the size structure to changes in abundance and function [@thibault2011; @yen2017]. In contrast to aquatic and forest systems, most long-term surveys of animal communities do not collect data on individuals' *sizes* across a full community (with the exception of small mammal studies, which have made major contributions to our understanding of the dynamics of size, abundance, and function for these systems; [@ernest2005; @white2004; @hernandez2011; @kelt2015]). Global, continental, or population-wide studies capture different phenomena [@white2007; this is a nod to a few studies looking at the size structure *across britain* or something]. The ISDs for terrestrial animals, and specifically for determinate growing taxa (e.g. mammals, birds), are often complex, multimodal distributions [@holling1992; @ernest2005; @thibault2011; @yen2017], and less statistically tractable than the power-law ISDs found in aquatic and tree systems [@kerr01; @white2007; more]. Quantifying change in the size structure, and relating this to change in community-wide abundance and function, is not as straightforward as computing and comparing slopes. As a result, we do not have a general understanding of either 1) how these ISDs behave over time or 2) the extent to which changes in the ISD decouple the community-level dynamics of abundance, biomass, and energy use in these systems.


Here, we begin to address this gap by exploring how temporal changes in species composition and the size spectrum modulate the relationship between total abundance, energy, and biomass for communities of North American breeding birds. We used allometric scaling to estimate community size and abundance data for the North American Breeding Bird Survey, and evaluated how changes in total abundance, biomass, and energy use have co-varied from 1988-2018. Specifically, we examined: 1) How often do these currencies change together vs. have decoupled dynamics?; 2) What are the dominant directions and magnitudes of the overall change and any decoupling between the currencies?; 3) To what extent do changes in the ISD translate into decoupling between abundance and function?

\newpage

# Methods

## Bird abundance data

We used data from the Breeding Bird Survey [@pardieck2019] to evaluate trends in abundance, biomass, and energy use. The Breeding Bird Survey consists of roughly 40km-long survey routes distributed throughout the United States and Canada. Routes are surveyed annually during the breeding season (predominately May-June), via 50 3-minute point counts during which all birds seen or heard are identified to species [@pardieck2019]. Sampling began in 1966, and routes have been added over time to a current total of roughly 3000 routes (@pardieck2019) We explored trends in abundance, biomass, and energy use over the 30-year time period from 1989-2018. We selected these years to provide a temporal window sufficient to detect trends (@cusser2020), while allowing for a substantial number of routes. To avoid irregularities caused by missing time steps, we restricted the main analysis to routes that had been sampled in at least 27 of 30 years in this window (n = 739), and compared these results to a more strict selection of routes that were sampled in every year (n = 199). We take the route to be the "community" scale [@thibault2011]. We filtered the data to remove taxa that are poorly sampled through these methods, following @harris2018. We accessed the data, and performed this preliminary cleaning and filtering, using the R package `MATSS` [@ye2020]. 

##  Estimated size data

BBS contains abundances for all species along a route in each year, but does not include measurements of individual body size. We generated body size estimates for individual birds assuming that intraspecific size distributions are normally distributed around a species’ mean body size (following @thibault2011). Using records of species’ mean and standard deviation body sizes from @dunning2008, we drew individuals’ body sizes from the appropriate normal distributions. For species for which there was not a standard deviation recorded in @dunning2008 (185 species affected, of 421 total), we estimated the standard deviation based on an allometric scaling relationship between mean and standard deviation in body mass ($log(variance) = -5.273 + (log(mass) * 1.995))$; model R2 .86; see also @thibault2011). For species with multiple records in @dunning2008, we used the mean mean and standard deviation body sizes across all records (averaging across sexes, subspecies, and records from different locations). We performed this averaging after estimating any missing standard deviation measurements. For each individual bird observed, we estimated metabolic rate as $10.5 * (mass ^.713)$ [@fristoe2015; @nagy2005; @mcnab2009]. For each route in a given year, we compute total energy use, total biomass, and total abundance by summing over all individuals observed on that route in that year. This method does not incorporate intraspecific variation in body size across geographies or over time [@dunning2008; @gardner2011]. However, it makes it possible to conduct macroecological studies of avian size distributions at a spatial and temporal scale that would otherwise be impossible [@thibault2011].

## Comparing abundance- and size- based currencies

Comparing trends across different currencies is a nontrivial statistical challenge. Because different currencies vary widely in their units of measure (e.g. abundance in the hundreds of individuals; total biomass in the thousands of grams), it is challenging to interpret differences in magnitude of slope across different currencies. Transformation and scaling using common approaches (such as a square-root transform or rescaling each currency to a mean of 0 and a standard deviation of 1; @gotelli2017; @dornelas2014) destroys necessary information about the degree of variability within each currency. 

Rather than attempting to compare slopes across currencies or to transform different currencies to a common scale, we use a simple null model to compare the observed dynamics for biomass and energy use to the dynamics that would occur in a scenario in which the species (and therefore, in this context, size) composition of the community was consistent throughout the timeseries, but in which total abundance varied over time consistent with the observed dynamics. For each route, we characterized the "observed" timeseries of total biomass and total energy use by simulating size measurements for all individuals observed in each time step and summing across individuals, using the method described above. We then created simulated timeseries for biomass and energy use incorporating observed changes in community-wide abundance over time, but under a scenario of consistent species (and therefore size) composition over time. For each community, we characterized the timeseries-wide probability of an individual drawn at random from the community belonging to a particular species ($P(s_i)$) as each species' mean relative abundance taken across all timesteps: 

$P(s_i) = \frac{\sum_t^T{\frac{n_{i, t}}{N_t}}}{T}$

where $n_{i, t}$ is the abundance of species $i$ in timestep $t$, $N_t$ is the total abundance of all species in timestep $t$, and $T$ is the total number of timesteps. For each timestep $t$, we randomly assigned species' identities to the observed number of individuals $N_t$ by drawing with replacement from a multinomial distribution with probabilities weighted according to $P(s)$ for all species. We then simulated body size measurements for individuals, and calculated total energy use and total biomass, following the same procedure as for the observed community. This estimates the dynamics for size-based currencies expected if the species (and size) composition of the community does not change over time, but incorporating observed fluctuations in total abundance. We refer to these dynamics as "abundance-driven" dynamics. 

## Long-term trends

For each route, we evaluated the 30-year trend in biomass (or energy use) and compared this to the trend derived from the "abundance-driven" null model using generalized linear models with a Gamma family and log link (appropriate for strictly-positive response variables such as biomass or total metabolic flux). We fit four models to characterize 1) the trend in biomass (or energy use) over time and 2) whether this trend deviates from the trend expected given only changes in abundance:

1. `biomass ~ year * source`, in which "source" refers to being either the "observed" or "abundance-driven" value. This model fits a slope and intercept for the observed trend in  biomass (or energy use) over time, and a separate slope and intercept for the trend drawn from the abundance-driven, or null model, dynamics.
2. `biomass ~ year + source`. This model fits a separate intercept, but not slope, for the abundance-driven and observed dynamics.
3. `biomass ~ year`. This model fits a temporal trend, but does not fit separate trends for the observed and abundance-driven dynamics.
4. `biomass ~ 1`. The intercept-only model describes no directional change over time for either the observed or abundance-driven dynamics. 

We selected the best-fitting model using AICc. In instances where multiple models had AICc scores within two AICc units of each other, we selected the simplest model within two units of the best score.

For each route's best-fitting model, we extracted the predicted values for the first (usually 1988) and last (usually 2018) year sampled, for both the observed and null trajectories. We calculated the magnitude of change over time as the ratio of the last (2018) to the first (1988) value, and characterized the direction of the long-term trend as increasing if this ratio was greater than one, and decreasing if it was less than one. 

## Relating change in community structure to decoupling between abundance and size-based dynamics

Community dissimilarity metrics are most interpretable when making pairwise comparisons (as opposed to repeated compasions over a timeseries). We compared the first and last five-year intervals in each timeseries, resulting in a "begin" and "end" comparison separated by a consistent window of time across routes (19-20 years). The use of five-year periods corrects for sampling effects (@white2004a), smooths out interannual variability, and, by including a relatively large proportion (1/3) of the total timeseries, partially mitigates the impact of scenarios where the start and end values do not align with the long-term trend. 

We calculated three metrics to explore how changes in community composition and size structure translate into decoupling between abundance-driven and observed dynamics for biomass and energy use.  First, we evaluated the change in average community-wide body size, calculated as the log ratio of mean body size in the last five years relative to the mean body size in the first five years:

$log(\frac{\bar{m}_{last5}}{\bar{m}_{first5}})$

where $\bar{m}_{last5}$ is the mean body size of all individuals observed in the last 5 timesteps. Large changes in average body size are, by definition, expected to translate into decoupling between observed and abundance-driven dynamics.

Second, we calculated measures of turnover in the size structure and in species composition. We calculated turnover in the ISD following an overlap measure that has previously been applied to species body size distributions in mammalian communities (@read2018). We characterized each "begin" or "end" ISD as a smooth probability density function by fitting a Gaussian mixture model (with up to 15 Gaussians) to the raw, and extracting the fitted probability density at each possible body mass ranging from 0 to exp(15) g (following @thibault2010). We rescaled each density function to sum to 1. To calculate the degree of turnover between two ISDs, we calculated the area of overlap between the two density smooths and subtracted this quantity from 1. To evaluate turnover in species composition between the five-year time periods, we calculated Bray-Curtis dissimilarity between the two communities using the R package `vegan`. 

We tested whether routes whose dynamics were best-described using different syndromes of change (no trend, couple trends, or decoupled trends) differed in 1) the magnitude of change in mean body size; 2) turnover in the ISD over time; or 3) species compositional turnover over time. For change in mean body size, we fit an ordinary linear model of the form `abs(log ratio (mean body size)) ~ best fitting model type`. We used the absolute log ratio so as to focus on the magnitude, rather than the direction, of change in body size. We compared this model to an intercept-only null model of the form `abs(log ratio(mean body size)) ~ 1` using AIC. Because our metrics for turnover in the ISD and species composition are bounded from 0-1, we analyzed these metrics using binomial generalized linear models of the form `ISD turnover ~ best fitting model type` and `dissimilarity ~ best fitting model type`, and again compared these models to intercept-only null models using AIC. In instances where the model fit with `best fitting model type` outperformed the intercept-only model, we calculated model estimates and contrasts using the R package `emmeans`. 


\newpage

# Results

NEEDS UPDATING

\newpage


# Discussion

## Decoupling of abundance, biomass, and energy use

Although the dynamics of size- and abundance- based currencies are intrinsically related to each other, decoupling in these dynamics for a substantial minority of communities results in qualitatively different continent-wide patterns in the long-term trends of abundance, biomass, and energy use. Despite a strong signal of declines in overall abundance across the routes in the BBS, the long-term trends in biomass are evenly divided between increases and decreases. 

First, this illustrates that we should extrapolate between currencies with some care. They are intrinsically linked, but changes in size structure can cause scaling relationships between each of the currencies to break down. Shifts in mean per capita body size decouple biomass from abundance, and different specific size compositions will result in different community-wide scaling between energy use and biomass. 

For routes with a decoupling in the long-term trends of biomass, energy use, and abundance, this decoupling is indicative of a directional shift in the size structure of the community. In the case of BBS, the overwhelmingly most common scenario is of a decline in abundance, but a shift in the size structure favoring larger-bodied species and offsetting or even reversing this decline in abundance. This contrasts with general concerns about larger-bodied species being more vulnerable to declines in abundance or outright extinctions due to anthropogenic changes. However, it is consistent with previous findings from the BBS [@schipper2016]. Increases in body size may reflect forests in recovery across North America, or the contributions of relatively few, large-bodied species that may in fact benefit from recent ecological changes. 

## How changes in the ISD contribute to decoupling

While an overall decoupling of the long-term trends for biomass, abundance, and energy use is symptomatic of a pronounced shift in the size structure, the absence of such a decoupling does not imply that the size structure has remained unchanged over time. Rather, the amount of turnover in the size structure over time is comparable for routes that do and do not exhibit long-term decoupling. Importantly, these size shifts may *also* reflect significant functional changes to the community, and should not be ignored simply because they have no overall or consistent effect on the long-term temporal trends.

Finally, we should acknowledge possibility that either random population dynamics, or systematic, but non-*size*-structured, dynamics, contribute to changes in both the size structure and in the relationship between biomass, energy use, and abundance over time. At a macroecological scale, null modeling approaches inspired by the study of functional and taxonomic beta diversity may help address this question [@swenson2011; @stegen2013]. However, these models are known to suffer from the "Narcissus effect" and to be highly sensitive to the information used to constrain the model, resulting in a high type-I error rate and reduced inferential power [@ulrich2017]. It may, therefore, be most informative to focus instead on the dynamics of particular systems and attempt to understand the interlinked dynamics of shifts in species composition, size structure, abundance, biomass, and energy use from a perspective grounded in empiricism and natural history. 

## Extensions to capture nonlinear dynamics

While linear approximations can help identify strong directional trends, they have significant limitations for understanding more complex biodiversity dynamics. Long-term trends may mask changes in direction of a trend over time, and it is challenging to distinguish between low-variability, and highly variable, but not *temporally* structured, timeseries in macroecological-scale datasets. This is doubly true in the context of comparing multiple abundance currencies to each other: complex dynamics of the size structure, and therefore the scaling between size- and abundance- based currencies, may be inadequately described by linear approximations. 

Again, a more system-specific perspective, combined with emerging statistical approaches, may  help move us towards a more nuanced understanding of the potential for nonlinear temporal dynamics. For example, generalized additive models (GAMS) present an emerging and promising tool set for exploring these more complex biodiversity dynamics. Generalized additive models can describe complex, nonlinear dynamics, and can be used to detect periods of time when the trajectories of multiple currencies decouple from each other. However, fitting GAMs for this application requires numerous decisions that depend on the specificities of a given dataset, and we lack conceptual frameworks for interpreting macroecological-scale aggregations of complex temporal dynamics. Efforts along these lines working with specific systems can help develop robust model fitting protocols and frameworks for interpretation that can eventually be applied to large-scale datasets such as the one presented here.

## Conclusion

This analysis demonstrates the usefulness and the limitations of a macroecological approach to studying community structure and function across levels of organization. In the first large-scale synthesis of the temporal dynamics of community size structure and function for terrestrial animals, we find that changes in species/size composition can and do drive qualitatively different long-term trajectories for size- and abundance- based currencies of function. This is indicative of widespread changes in community size structure that may reflect substantive changes in functional composition. Future, potentially smaller-scale, work will be instrumental in identifying the processes driving these shifts and characterizing more nuanced relationships between size and abundance over time in these systems. 

\newpage

# Figures and tables

# Figure 1. Abundance-driven vs. observed change

```{r, fig.dim = c(5,3)}

loadd(all_sims, cache=cache)
rn <- "bbs_rtrg_28_4"
dat <- readd(rn, character_only = T, cache=cache)
source(here::here("analyses", "fxns", "hasty_fxns.R"))

dat_sliced <- slice_dat(dat)
dat_resp <- resp_dat(dat_sliced)

dat_isd <- simulate_isd_ts(dat_sliced, isd_seed = 1989)
dat_resp_isd <- simulate_isd_ts(dat_resp, isd_seed = 1989)

years <- unique(dat_sliced$covariates$year)

begin_years <- years[1:5]
end_years <- years[(length(years) - 4):length(years)]

begin_isd_real <- filter(dat_isd$isd, year %in% begin_years)
end_isd_real <- filter(dat_isd$isd, year %in% end_years )

begin_isd_sim <- filter(dat_resp_isd$isd, year %in% begin_years)
end_isd_sim <- filter(dat_resp_isd$isd, year %in% end_years)

begin_isd_gmm_real <- add_gmm(begin_isd_real) %>%
  mutate(time = "begin")
end_isd_gmm_real <- add_gmm(end_isd_real) %>%
  mutate(time = "end")

real_gmms <- bind_rows(begin_isd_gmm_real, end_isd_gmm_real) %>%
  mutate(simtype = "Observed")

begin_isd_gmm_sim <- add_gmm(begin_isd_sim) %>%
  mutate(time = "begin")
end_isd_gmm_sim <- add_gmm(end_isd_sim)  %>%
  mutate(time = "end")
sim_gmms <- bind_rows(begin_isd_gmm_sim, end_isd_gmm_sim) %>%
  mutate(simtype = "Abundance driven")

both_gmms <- bind_rows(real_gmms, sim_gmms)
```

```{r}
isd_plots <- ggplot(filter(both_gmms, exp(mass) > 5, exp(mass) < 5000), aes(exp(mass), density, color = simtype, linetype = time)) + 
  geom_line() + 
  facet_wrap(vars(simtype), ncol = 2, scales = "free_y") + 
  theme(legend.position = "bottom") + 
  scale_color_viridis_d(option = "cividis",begin = .2,  end = .8) + 
  ylab("Probability density")+ 
  xlab("Mass (g); note log scale") +
  scale_x_log10()

#isd_plots

```

```{r}


dat_dynamics <- filter(all_sims, matssname == rn)

dat_glm <- glm(total_biomass ~ timeperiod * source, data = dat_dynamics, family= Gamma(link = "log"))

dat_lm <- lm(total_biomass ~ timeperiod * source, data = dat_dynamics)


dat_dynamics <- dat_dynamics %>%
  mutate(fitted = predict(dat_glm, type = "response")) %>%
  mutate(simtype = ifelse(source == "sim", "Abundance driven", "Observed")) %>%
  mutate(time = "begin") 

timeseries_plot <- ggplot(dat_dynamics, aes(timeperiod, total_biomass, color = simtype)) +
  geom_point() + 
  geom_line() + 
  geom_line(aes(y = fitted)) + 
  # geom_rect(aes(xmin = years[1], xmax = years[5], ymin = min(total_biomass), ymax = max(total_biomass), time = "begin"), alpha = 0, color = "black")+ 
  # geom_rect(data=  mutate(dat_dynamics, time = "end"), aes(xmin = years[length(years) - 4], xmax = years[length(years)], ymin = min(total_biomass), ymax = max(total_biomass),linetype = time), alpha = 0, color = "black")+
  scale_color_viridis_d(option = "cividis",begin = .2,  end = .8) + 
  theme(legend.position = "none") +
  xlab("Year") +
  ylab("Biomass")

#timeseries_plot
```

```{r, fig.dim = c(6,4.25)}
two_plots <- multi_panel_figure(columns = 1 ,height = c(2,2.25), unit = "in") %>%
  fill_panel(timeseries_plot) %>%
  fill_panel(isd_plots)

two_plots
```

#### Figure 1. 

Illustration of abundance-driven (null model) dynamics as compared to observed dynamics (A), and the underlying dynamics of the ISD (B) for a sample route (`r dat_isd$metadata$location$routename`, `r dat_isd$metadata$location$regionname`). **A. Dynamics of total biomass.** The gold points show the true values for total biomass in each year, and the blue points show the values for total biomass simulated from a null model that incorporates change in total abundance, but assumes no change in the size structure, over time. The smooth lines show the predicted values from a Gamma (log-link) linear model of the form `total_biomass ~ year * simtype`. <!-- Using gaussian here because it is easier to interpret directly and compute r2. results are the same if you use Gamma --> For this route, change in the individual size distribution has decoupled the dynamics of biomass from those that would occur due only to changes in abundance. The slope for abundance-driven dynamics is significantly more negative than for the observed dynamics (interaction term p = 0.0013). **B. Underlying changes in the ISD.** The individual size distributions for the first 5 years (solid lines) and last 5 years (dashed lines) of the timeseries. The x-axis is body size (as mass in grams; note log scale) and the y-axis is probability density from a Gaussian mixture model fit to a vector of simulated individual masses for all individuals observed in the years in questions, standardized to sum to 1. For the abundance-driven (blue) scenario, individuals' species identities (which determine their body size estimates) are re-assigned at random weighte by each species' mean relative abundance throughout the timeseries, resulting in a consistent individual size distribution over time. For the observed (gold) scenario, individuals' body sizes are estimated based actual species abundances at each time step. For this route, species composition has shifted over time and produced different ISDs for the "begin" and "end" time periods. Specifically, the "end" ISD has peaks at larger body sizes (ca. 90g and 500g) not present in the "begin" ISD. This redistribution of density towards larger body sizes results in an overall increase in body size community wise, which partially offsets declines in total biomass from those expected given change in abundance alone. 

\newpage


```{r load and process biomass results}

loadd(all_preds, cache=cache)
loadd(all_aics, cache=cache)

winning_aics <- all_aics %>%
  filter(model_family == "Gamma") %>%
  group_by(matssname, model_family) %>%
  mutate(minAICc = min(model_AICc)) %>%
  mutate(deltaAICc = minAICc - model_AICc)  %>%
  mutate(exp_deltas = exp(.5 * deltaAICc)) %>%
  mutate(denom = sum(exp_deltas)) %>%
  mutate(aicc_wt = exp_deltas/ denom) %>%
  arrange(desc(aicc_wt)) %>%
  mutate(rank =row_number()) %>%
  ungroup() %>%
  arrange(matssname, model_family, rank)

delta_2 <- winning_aics %>% filter(deltaAICc > -2) %>%
  filter(model_family == "Gamma") %>%
  group_by(matssname, model_family) %>%
  arrange(modelcomplexity) %>%
  mutate(rank = row_number()) %>%
  filter(rank == 1) %>%
  ungroup()

winning_fits <- delta_2 %>%
  left_join(all_preds) 

slope_winning_fits <- winning_fits %>%
  filter(modelcomplexity > 1)
# 
# interaction_winning_fits <- winning_fits %>%
#   filter(modelcomplexity > 2)


biomass_slopes_long <- slope_winning_fits %>%
  select(matssname, ratio_sim, ratio_real) %>%
  tidyr::pivot_longer(-matssname, names_to = "source", values_to = "biomass_ratio") %>%
  mutate(simtype = ifelse(source == "ratio_sim", "Abundance driven", "Observed"))

```


```{r load and process energy results}

loadd(all_preds_energy, cache=cache)
loadd(all_aics_energy, cache=cache)

winning_aics_energy <- all_aics_energy %>%
  filter(model_family == "Gamma") %>%
  group_by(matssname, model_family) %>%
  mutate(minAICc = min(model_AICc)) %>%
  mutate(deltaAICc = minAICc - model_AICc)  %>%
  mutate(exp_deltas = exp(.5 * deltaAICc)) %>%
  mutate(denom = sum(exp_deltas)) %>%
  mutate(aicc_wt = exp_deltas/ denom) %>%
  arrange(desc(aicc_wt)) %>%
  mutate(rank =row_number()) %>%
  ungroup() %>%
  arrange(matssname, model_family, rank)

delta_2_energy <- winning_aics_energy %>% filter(deltaAICc > -2) %>%
  filter(model_family == "Gamma") %>%
  group_by(matssname, model_family) %>%
  arrange(modelcomplexity) %>%
  mutate(rank = row_number()) %>%
  filter(rank == 1) %>%
  ungroup()


winning_fits_energy <- delta_2_energy %>%
  left_join(all_preds_energy)

slope_winning_fits_energy <- winning_fits_energy %>%
  filter(modelcomplexity > 1)
# 
# interaction_winning_fits_energy <- winning_fits_energy %>%
#   filter(modelcomplexity > 2)


energy_slopes_long <- slope_winning_fits_energy %>%
  select(matssname, ratio_sim, ratio_real) %>%
  tidyr::pivot_longer(-matssname, names_to = "source", values_to = "energy_ratio") %>%
  mutate(simtype = ifelse(source == "ratio_sim", "Abundance driven", "Observed"))



winning_fits_both <- winning_fits %>%
  mutate(currency = "biomass") %>%
  bind_rows(mutate(winning_fits_energy, currency = "energy"))


```


\newpage

# Figure 2. Directions and magnitudes of change.

```{r, fig.dim = c(4,4)}

biomass_slope_histogram <- ggplot(biomass_slopes_long, aes(biomass_ratio, color = simtype, fill = simtype)) + geom_histogram(boundary = 1) + scale_x_log10() + geom_vline(xintercept = 1) + facet_wrap(vars(simtype), scales = "free_y") + scale_color_viridis_d(option = "cividis", begin = .2, end = .8) + scale_fill_viridis_d(option = "cividis", begin = .2, end = .8) +
  theme(legend.position = "none") + ggtitle("Total biomass") + xlab("")


energy_slope_histogram <- ggplot(energy_slopes_long, aes(energy_ratio, color = simtype, fill = simtype)) + geom_histogram(boundary = 1) + scale_x_log10() + geom_vline(xintercept = 1) + facet_wrap(vars(simtype), scales = "free_y") + scale_color_viridis_d(option = "cividis", begin = .2, end = .8) + scale_fill_viridis_d(option = "cividis", begin = .2, end = .8) +
  theme(legend.position = "bottom") + ggtitle("Total metabolic flux") + xlab("Ratio of last fitted value to first fitted value")

slope_histograms <- multi_panel_figure(columns = 1, height = c(1.6, 2), unit = "in") %>%
  fill_panel(biomass_slope_histogram) %>%
  fill_panel(energy_slope_histogram)
slope_histograms
```

#### Figure 2. Long-term trends in total biomass and energy use

Histograms showing the direction and magnitude of change over time for the abundance-driven (left) and observed (right) changes in biomass (A) and energy use (B), for communities with a significant slope and/or interaction term (for biomass, 500/739 routes; for energy use, 509/739 routes). Change is summarized as the ratio of the fitted value for the last year in the time series to the fitted value for the first year in the timeseries from the best-fitting model for that community. Values greater than 1 (vertical black line) indicate increases in total energy or biomass over time, and less than 1 indicate decreases. The abundance-driven dynamics (left) reflect the trends fit for the null model, while the observed dynamics (right) reflect trends incorporating both change in total abundance and change in the size structure over time. For communities with no significant interaction term in the best-fitting model, the "abundance-driven" and "observed" ratios will be the same; interaction terms will result in different ratios for "abundance-driven" and "observed" dynamics. 

Among routes with temporal trends, there are qualitatively different continental-wide patterns in abundance-driven and observed dynamics for total biomass and total metabolic flux. 70% of trends in abundance-driven dynamics for energy use are decreasing, and 67% for biomass. However, for biomass, observed dynamics are balanced evenly between increases (49% of routes) and decreases (51%) - indicating that changes in the size structure produce qualitatively different long-term trends for biomass than would be expected given abundance changes alone. However, trends for energy use (which scales nonlinearly with biomass) are dominated by decreases (35% of routes), more closely mirroring the trends expected given changes in abundance. 

\newpage

# Tables: Model outcomes

<!-- and directions of trends  -->

### Table 1.

```{r model outcomes table, results = T}

model_outcomes_table <- winning_fits_both %>%
  select(matssname, model_family, model_formula, currency)  %>%
  group_by(currency, model_formula) %>%
  summarize(n = dplyr::n()) %>%
  ungroup() %>%
  group_by(currency) %>%
  mutate(nmods = sum(n)) %>%
  mutate(prop = n / nmods) 

model_outcomes_table_pretty <- model_outcomes_table %>%
  mutate(currency = ifelse(currency == "biomass", "Total biomass", "Total metabolic flux")) %>%
  mutate(prop_rounded = round(prop, digits = 2),
         form_pretty = ifelse(grepl("1", model_formula), "Intercept-only", ifelse(grepl("source", model_formula), "Decoupled trend", "Trend, not decoupled"))) %>%
  select(currency, form_pretty, n, prop_rounded) %>%
  rename(`Selected model` = form_pretty,
         `Number of routes` = n,
         `Proportion of routes` = prop_rounded,
         Currency = currency) 

model_outcomes_table_pretty

```
#### Table 1. Selected models.

Table of the number and proportion of routes whose dynamics for total biomass and total energy use are best-fit by: a model with no temporal trend (intercept-only model, `response ~ 1`); a model with a temporal trend, but no difference in trend between observed and abundance-driven dynamics (`response ~ timeperiod`); or a model with decoupled temporal trends for observed and abundance-driven dynamics (`response ~ timeperiod * source`). 

For 31-32% of routes, models with trends do not outperform simple intercept-only models. For the remaining routes, in most instances, the dynamics of biomass and energy use exhibit a temporal trend, but with no detectable difference in the temporal trends for abundance-driven and observed dynamics. However, for a substantial minority of routes (20% overall for biomass, or 30% of routes with a temporal trend; 7% overall for energy use, or 10% of routes with a temporal trend), there is a detectable deviation between the trends expected due only to changes in abundance and the observed dynamics. 

### Table 2.


```{r}

slope_winning_fits <- filter(winning_fits_both, modelcomplexity > 1) %>%
  mutate(abundance_driven_increase = ratio_sim > 1,
         observed_increase = ratio_real > 1)

slope_winning_fits_summary <- slope_winning_fits %>%
  group_by(currency) %>%
  summarize(n_with_slope = dplyr::n(),
            n_abundance_increase = sum(abundance_driven_increase),
            n_observed_increase = sum(observed_increase),
            prop_abundance_increase = round(mean(abundance_driven_increase), digits = 2),
            prop_observed_increase = round(mean(observed_increase), digits = 2))

slope_winning_fits_pretty <- slope_winning_fits_summary %>%
  mutate(currency = ifelse(currency == "biomass", "Total biomass", "Total metabolic flux")) %>%
  select(currency,
         # n_abundance_increase,
         # n_observed_increase,
         prop_abundance_increase,
         prop_observed_increase,
         n_with_slope) %>%
  rename(Currency = currency,
         # `Number of routes with abundance-driven increase`= n_abundance_increase,
         # `Number of routes with observed increase`  = n_observed_increase,
         `Proportion of increasing abundance-driven trends` = prop_abundance_increase,
         `Proportion of increasing observed trends` = prop_observed_increase,
         `Number of routes with temporal trends` = n_with_slope)

slope_winning_fits_pretty

```

#### Table 2. Direction of temporal trends in abundance-driven and observed dynamics.

Restricted to the routes exhibiting temporal trends in total biomass and total metabolic flux, the proportion of trends that are increasing (specifically, the ratio of the last fitted value to the first fitted value > 1) for abundance-driven and observed dynamics. Trends that are not increasing are decreasing.

Trends in abundance-driven dynamics are dominated by *declines* (67% of routes for total biomass, and 70% of routes for total energy). Observed dynamics for biomass differ qualitatively from the abundance-driven dynamics; observed trends in biomass are evenly divided between increases and decreases (49% increasing). Observed trends in energy use more closely mirror abundance-driven trends (65% declines).

I think Table 2 can be removed/folded into the legend of Figure 2.

\newpage

# Figure 3. Visualizing decoupling

```{r}

interaction_all_fits <- all_preds %>% 
  # get just the change ratios from the interaction models - regardless of whether the interaction model is the best-fitting model. this is because we want an estimate of the slope, we'll color by model fit in a minute
  group_by_all() %>% 
  filter(grepl( "* source",model_formula), model_family == "Gamma") %>%
  mutate(plus = substr(model_formula, 12,12) == "+") %>% filter(!plus) %>%
  ungroup() %>%
  # now join to *winning* formulas to get the best fitting formula
  left_join(select(winning_fits, matssname, model_formula, modelcomplexity) %>%
              rename(winning_formula = model_formula)) %>%
  select(winning_formula, ratio_sim, ratio_real, matssname, modelcomplexity) %>%
  mutate(currency = "Biomass")


interaction_all_fits_energy <- all_preds_energy  %>% 
  # get just the change ratios from the interaction models - regardless of whether the interaction model is the best-fitting model. this is because we want an estimate of the slope, we'll color by model fit in a minute
  group_by_all() %>% 
  filter(grepl( "* source",model_formula), model_family == "Gamma") %>%
  mutate(plus = substr(model_formula, 12,12) == "+") %>% filter(!plus) %>%
  ungroup() %>%
  # now join to *winning* formulas to get the best fitting formula
  left_join(select(winning_fits_energy, matssname, model_formula, modelcomplexity) %>%
              rename(winning_formula = model_formula)) %>%
  select(winning_formula, ratio_sim, ratio_real, matssname, modelcomplexity) %>%
  mutate(currency = "Metabolic flux")


all_interaction <- bind_rows(interaction_all_fits, interaction_all_fits_energy) %>%
  mutate(`Best fitting model` = ifelse(modelcomplexity == 1, "No trend", ifelse(modelcomplexity == 2, "Coupled trend", "Decoupled trends")))


```


```{r, fig.dim= c(5.5,3)}

decoupling_plot <- ggplot(all_interaction, aes(ratio_sim, ratio_real, color = `Best fitting model`)) + 
  geom_point(alpha = .5) + 
  #geom_point(data = filter(all_interaction, winning_formula != "1"), aes(color = winning_formula), alpha = .3) + 
  scale_y_log10() + 
  scale_x_log10() + 
  scale_color_viridis_d(option = "mako", end = .8, direction = -1) + 
  theme(legend.position = "bottom") + 
  geom_abline(intercept = 0, slope = 1) + 
 geom_vline(xintercept = 1, linetype = 2) + 
  geom_hline(yintercept = 1, linetype =2) +
  xlab("Abundance-driven change \n Ratio of last fitted value to first fitted value") + 
  ylab("Observed change \n Ratio of last fitted value to first fitted value") +
  facet_wrap(vars(currency), ncol = 2)


decoupling_plot
```


#### Figure 3. Decoupling between abundance-driven and observed trends.

Observed change (ratio of last fitted value to first fitted value, y-axis) in total biomass (left) and total metabolic flux (right) compared to the change expected only due to changes in total abundance (ratio of last fitted value to first fitted value, x-axis). Values greater than 1 (dashed horizontal and vertical lines) mark positive (increasing) trends, while values less than 1 are negative trends. Each point marks the fitted values from a Gamma log-link generalized linear model of the form `response ~ year * source` for a given route. This estimates separate long-term slopes for observed and abundance-driven dynamics. Points are colored corresponding to the best-fitting model (intercept-only, or "no trend"; a slope for year but no difference in slopes between observed and abundance-driven dynamics, or "coupled trend", and separate slopes for observed and abundance-driven dynamics, "decoupled trends") for each route. Deviations from the 1:1 line (solid black line) reflect changes in the community size structure that modulate the relationship between total abundance and total biomass or energy use. 

Changes in total biomass and total energy use generally track changes driven by fluctuations in total abundance, with appreciable scatter around the 1:1 line. When this translates into a statistically detectable decoupling between observed and abundance-driven dynamics ("Decoupled trends"), this is usually in the form of abundance-driven change being more negative (a steeper decline or a smaller increase) than observed change in biomass or energy use (a less steep decline or larger increase), and occurs more strongly and frequently for biomass than for metabolic flux.


 \newpage
 
# Figure 4. How community change to decoupling

```{r}

loadd(all_isd_compares, cache =cache)

winning_fits <- winning_fits %>% 
  left_join(all_isd_compares) %>%
  mutate(`Best fitting model` = ifelse(modelcomplexity == 1, "No trend", ifelse(modelcomplexity == 2, "Coupled trend", "Decoupled trends")))


winning_fits <- winning_fits %>%
  mutate(categorical_fit = `Best fitting model`) %>%
  mutate(categorical_fit = as.factor(categorical_fit)) %>%
  mutate(abs_log_ratio = abs(log(real_end_mean_mass / real_begin_mean_mass)),
         log_ratio = log(real_end_mean_mass/real_begin_mean_mass)) %>%
  mutate(isd_turnover = 1 - real_overlap)

isd_mean_change_plot <-  ggplot(winning_fits, aes(log_ratio, color = `Best fitting model`, fill= `Best fitting model`)) + 
  geom_histogram() + 
  facet_wrap(vars(`Best fitting model`), scales = 'free_y', ncol = 1) +
  scale_color_viridis_d(option = "mako", end = .8, direction = -1) +     
  scale_fill_viridis_d(option = "mako", end = .8, direction = -1) +
  theme(legend.position = "none") +
  xlab("Mean mass log ratio") +
  ylab("Count") +
  ggtitle("Mean size change")
# 
# mean_change_coupled <- filter(winning_fits, modelcomplexity == 2)
# mean_change_decoupled <- filter(winning_fits, modelcomplexity == 4)
# mean_change_nt <- filter(winning_fits, modelcomplexity == 1)
# 
# ks.test(mean_change_coupled$ratio_real, mean_change_decoupled$ratio_real)
# 
# 
# ks.test(mean_change_coupled$real_overlap, mean_change_decoupled$real_overlap)
# 
# ks.test(mean_change_coupled$real_overlap, mean_change_nt$real_overlap)
# 
# 
# ks.test(mean_change_decoupled$real_overlap, mean_change_nt$real_overlap)
# 
# ks.test(c(mean_change_nt$real_overlap,mean_change_coupled$real_overlap), mean_change_decoupled$real_overlap)


```

```{r}

isd_overlap_plot <- ggplot(winning_fits, aes(isd_turnover,color = `Best fitting model`, fill= `Best fitting model`)) + 
  geom_histogram() + 
  facet_wrap(vars(`Best fitting model`), scales = 'free_y', ncol = 1) +
  scale_color_viridis_d(option = "mako", end = .8, direction = -1) +  scale_fill_viridis_d(option = "mako", end = .8, direction = -1) +
  theme(legend.position = "none") +
  xlab("ISD turnover") +
  ylab("Count") +
  ggtitle("ISD turnover")




bcd_plot <- ggplot(winning_fits, aes(sp_turnover_bcd,color = `Best fitting model`, fill= `Best fitting model`)) + 
  geom_histogram() + 
  facet_wrap(vars(`Best fitting model`), scales = 'free_y', ncol = 1) +
  scale_color_viridis_d(option = "mako", end = .8, direction = -1) +  scale_fill_viridis_d(option = "mako", end = .8, direction = -1) +
  theme(legend.position = "none") +
  xlab("Bray-Curtis index") +
  ylab("Count") +
  ggtitle("Species turnover")
 # isd_overlap_plot
# 
# isd_glm <- glm(real_overlap ~ model_formula, family = "binomial", data = winning_fits)
# #
# # AIC(isd_glm)
# # AIC(glm(real_overlap ~ 1, family = "binomial", data = winning_fits))
# 
# glm_cor <- cor(predict(isd_glm, type = "response"), isd_glm$model[,1]) ^ 2
```

```{r, fig.dim = c(6, 3.5)}

isd_change_plots <- multi_panel_figure(columns = 3, rows = 1) %>%
  fill_panel(isd_mean_change_plot) %>%
  fill_panel(isd_overlap_plot) %>%
  fill_panel(bcd_plot)
isd_change_plots
```


#### Figure 4. Histograms of change in community structure for routes showing no trends, coupled, and decoupled trends in abundance-driven and observed dynamics.

Histograms of (A) change in mean body size from the first to the last five years of monitoring, (B) overall change in the size structure, and (C) change in species composition for routes whose dynamics for  total biomass were best-described using no temporal trend (bottom row; intercept-only model), separate trends for observed and abundance-driven dynamics (middle row), or the same trend for observed and abundance-driven dynamics (top row). Change in mean body size (A) is calculated as the ratio of the mean body size of all individuals observed in the last 5 years of the timeseries relative to the mean body size of all individuals observed in the first 5 years. Overall change in the ISD (B) is calculated as the degree of turnover between the ISDs for the first and last five years of the timeseries (see text). Change in species composition (C) is Bray-Curtis dissimilarity comparing species composition in the first five years to the last five years. 

Routes that exhibit decoupling between observed and abundance-driven changes in total biomass exhibit a high prevalence of increases and decreases in mean body size (middle row, panel A) compared to the changes seen in routes that show either no trend or non-decoupled trends. However, routes with all three signatures of dynamics (coupling, decoupling, or no trend) are not detectably different in the degree of overall change in the ISD or in species composition over time (panels B and C).

\newpage

# Statistical comparisons of distributions in Figure 4

### Mean mass

Linear model fit to `abs(log(end_mean_mass / begin_mean_mass))`:

First, anova comparing a model fit as `abs_log_ratio ~ model_type` to an intercept-only model:

```{r, results = T}

mean_mass_lm <- lm(abs_log_ratio ~ categorical_fit, data = winning_fits)

mean_mass_lm_intercept <- lm(abs_log_ratio ~ 1, data = winning_fits)

anova(mean_mass_lm, mean_mass_lm_intercept)

```


The fit to model type is superior to the intercept-only model, so evaluating the estimated values and contrasts:

```{r, results = T}
mean_mass_lm_emmeans <- emmeans::emmeans(mean_mass_lm, specs = ~ categorical_fit)

as.data.frame(mean_mass_lm_emmeans)

as.data.frame(pairs(mean_mass_lm_emmeans))
```


Decoupled trends models have higher absolute log ratios than no trend or coupled trend models. 


### ISD turnover

Comparing a binomial GLM (ISD overlap is bounded 0-1) fit to model type to an intercept-only model:


```{r, results = T}

overlap_glm <- glm(isd_turnover ~ categorical_fit, data = winning_fits, family = "binomial")

overlap_glm_intercept <- glm(isd_turnover ~ 1, data = winning_fits, family = "binomial")

anova(overlap_glm, overlap_glm_intercept, test = "Chi")

```


The model fit model is not superior to the intercept only model (p = .91).


### Bray-Curtis dissimilarity


Comparing a binomial GLM fit to model type to an intercept-only model:


```{r, results = T}

bcd_glm <- glm(sp_turnover_bcd ~ categorical_fit, data = winning_fits, family = "binomial")

bcd_glm_intercept <- glm(sp_turnover_bcd ~ 1, data = winning_fits, family = "binomial")

anova(bcd_glm, bcd_glm_intercept, test = "Chi")

```


The model fit model is not superior to the intercept only model (p = .37).





\newpage
# References
