---
output:
  pdf_document: 
    df_print: kable
  # html_document:
  #   df_print: kable
  word_document:
    reference_docx: default_gdoc.docx
    df_print: kable
csl: ecology.csl
bibliography: refs.bib
---
# Introduction

Understanding the interrelated dynamics of size- and -abundance based dimensions of biodiversity is key to understanding biodiversity change in the Anthropocene. Total abundance - i.e. the total number of individual organisms present in a system - and size-based currencies, such as the total biomass or total metabolic flux (“energy use”) of a system, are intertwined, but nonequivalent, measures of biological function. Abundance is more closely tied to species-level population dynamics, while size-based metrics more directly reflect assemblage-level resource use and contributions to materials fluxes at the broader ecosystem scale [@morlon2009; @dornelas2011; @white2007; @connolly2005]. While these currencies are naturally linked [@henderson2010; @morlon2009], changes in size composition can decouple the dynamics of one currency from another [@dornelas2011; @white2004; @white2007; @ernest2009; @yen2017]. This can mean that intuition from one currency may be misleading about others; a trend in numerical abundance might mask something else going on with biomass [@white2004]. Changes in size composition strong enough to decouple currencies may be symptomatic of important changes in ecosystem status- e.g. abundance-biomass comparison curves [@petchey2010]; size-biased extinctions [@young2016; @smith2018]. This underscores the need to understand how these dynamics are playing out in the Anthropocene [@fisher2010]. 


At the **community scale**, changes in the relationship between size and abundance tells us about important functional shifts. This is the scale at which ecological processes (i.e. compensatory dynamics, niche tracking, functional replacement) come into play - in contrast to population or global trends [@mcgill2015; @dornelas2014; @white2007]. To the extent that size is a proxy for other functional traits, changes or consistency in the community-level size structure (individiual size distribution, ISD) over time may reflect processes related to niche structure [@white2007; @petchey2010]. Strong size shifts can decouple the relationship between abundance and biomass. In aquatic systems, such changes in the scaling between abundance and biomass often signal ecosystem degradation [@petchey2010; @kerr01; @warwick1994 and refs therein]. Compensatory shifts in the size structure can buffer community function (in terms of biomass or energy use) against changes in abundance [@terry2015; @ernest2009; @white2004]. Consistency in the size structure may maintain the relationship between size- and -abundance based currencies, even as species composition, total abundance, and total biomass/total energy use fluctuate over time, which can reflect consistency in the niche structure over time [@holling1992]. 


It is important to improve our understanding of these dynamics for terrestrial animal communities in particular. In contrast to terrestrial trees and aquatic systems [@kerr01; @white2007], how the relationship between size and abundance changes over time, and the consequences of these changes for ecosystem-level properties, remain relatively unknown for terrestrial animals (but see @white2004). Terrestrial animal communities exhibit size structure [@ernest2005; @thibault2011], and case studies have demonstrated that size shifts can either decouple N from E for terrestrial animals [@white2004; @yen2017], but not always [@hernandez2011]. Establishing generalities in these dynamics is especially pertinent in the Anthropocene, as these communities are experiencing extensive and potentially size-structured change, with implications at community, ecosystem, and global scales [@young2016; @schmitz2018].

Macroecological-scale synthesis on the interrelated dynamics of the ISD, total abundance, and community function for terrestrial animals has been constrained by 1) a lack of community-level size and abundance timeseries data for these systems [@white2007; @thibault2011], and 2) appropriate statistical methods for relating change in the size structure to changes in abundance and function [@thibault2011; @yen2017]. In contrast to aquatic and forest systems, most long-term surveys of animal communities do not collect data on individuals' *sizes* across a full community (with the exception of small mammal studies, which have made major contributions to our understanding of the dynamics of size, abundance, and function for these systems; [@ernest2005; @white2004; @hernandez2011; @kelt2015]). Global, continental, or population-wide studies capture different phenomena [@white2007; this is a nod to a few studies looking at the size structure *across britain* or something]. The ISDs for terrestrial animals, and specifically for determinate growing taxa (e.g. mammals, birds), are often complex, multimodal distributions [@holling1992; @ernest2005; @thibault2011; @yen2017], and less statistically tractable than the power-law ISDs found in aquatic and tree systems [@kerr01; @white2007; more]. Quantifying change in the size structure, and relating this to change in community-wide abundance and function, is not as straightforward as computing and comparing slopes. As a result, we do not have a general understanding of either 1) how these ISDs behave over time or 2) the extent to which changes in the ISD decouple the community-level dynamics of abundance, biomass, and energy use in these systems.


Here, we begin to address this gap by exploring how temporal changes in species composition and the size spectrum modulate the relationship between total abundance, energy, and biomass for communities of North American breeding birds. We used allometric scaling to estimate community size and abundance data for the North American Breeding Bird Survey, and evaluated how changes in total abundance, biomass, and energy use have co-varied from 1988-2018. Specifically, we examined: 1) How often do these currencies change together vs. have decoupled dynamics?; 2) What are the dominant directions and magnitudes of the overall change and any decoupling between the currencies?; 3) To what extent do changes in the ISD translate into decoupling between abundance and function?

\newpage

# Methods

## Bird abundance data

We used data from the Breeding Bird Survey [@sauer2013] to evaluate trends in abundance, biomass, and energy use. BBS (BBS methods background). We explored trends in abundance, biomass, and energy use over the 30-year time period from 1988-2018. We selected these years to provide a temporal window sufficient to detect trends (@cusser2020), while allowing for a substantial number of routes. To avoid irregularities caused by missing time steps, we restricted the main analysis to routes that had been sampled every year from 1988-2018 (n = 350), and compared these results to a more inclusive selection of routes that were sampled in at least 25 of 30 years in this window (n >1000).  We take the route to be the "community" scale [@thibault2011; others]. We filtered the data to remove taxa that are poorly sampled through these methods, following (literally everyone). We accessed the data, and performed this preliminary cleaning and filtering, using the R package `MATSS` [@ye2020]. 

##  Estimated size data

BBS contains abundances for all species along a route in each year, but does not include measurements of individual body size. We generated body size estimates for individual birds assuming that intraspecific size distributions are normally distributed around a species’ mean body size (following @thibault2011). Using records of species’ mean and standard deviation body sizes from @dunning2008, we drew individuals’ body sizes from the appropriate normal distributions. For species for which there was not a standard deviation recorded in @dunning2008 (185 species affected, of 421 total), we estimated the standard deviation based on an allometric scaling relationship between mean and standard deviation in body mass ($log(variance) = -5.273 + (log(mass) * 1.995))$; model R2 .86; see also @thibault2011). For species with multiple records in @dunning2008, we used the mean mean and standard deviation body sizes across all records (averaging across sexes, subspecies, and records from different locations). We performed this averaging after estimating any missing standard deviation measurements. For each individual bird observed, we estimated metabolic rate as $10.5 * (mass ^.713)$ [@fristoe2015; @nagy2005; @mcnab2009]. For each route in a given year, we compute total energy use, total biomass, and total abundance by summing over all individuals observed on that route in that year. This method does not incorporate intraspecific variation in body size across geographies or over time [@dunning2008; @gardner2011]. However, it makes it possible to conduct macroecological studies of avian size distributions at a spatial and temporal scale that would otherwise be impossible [@thibault2011].

## Comparing abundance- and size- based currencies

Comparing trends across different currencies is a nontrivial statistical challenge. Because different currencies vary widely in their units of measure (e.g. abundance in the hundreds of individuals; total biomass in the thousands of grams), it is challenging to interpret differences in magnitude of slope across different currencies. Transformation and scaling using common approaches (such as a square-root transform or rescaling each currency to a mean of 0 and a standard deviation of 1; @gotelli2017; @dornelas2014) destroys information about the degree of variability within each currency. 

Rather than attempting to compare slopes across currencies or to transform different currencies to a common scale, I use a simple null model to compare the observed dynamics for biomass and energy use to the dynamics that would occur in a scenario in which the species (and therefore size) composition of the community was consistent throughout the timeseries, but in which total abundance varied over time consistent with the observed dynamics. For each route, we characterized the "observed" timeseries of total biomass and total energy use by simulating size measurements for all individuals observed in each time step and summing across individuals, using the method described above. We then created simulated timeseries for biomass and energy use by re-assigning the species identities of individuals based on each species' mean relative abundance throughout the timeseries. For each time step, we calculated the relative abundance for each species. For each species, we then took the mean relative abundance over all time steps. We used the distribution of species' mean relative abundances as the weights for a multinomial distribution describing the probability than an individual drawn at random from the community is of a particular species. For every timestep, we assigned species identities to individuals by sampling the observed number of individuals from this timeseries-wide multinomial distribution. We then simulated body size measurements for individuals, and calculated total energy use and total biomass, following the same procedure as for the observed community. This estimates the dynamics for size-based currencies expected if the species (and size) composition of the community does not change over time, but incorporating observed fluctuations in total abundance. 

### Linear trends

For each route, we evaluated the 30-year trend in biomass (or energy use) and compared this to the trend derived from the null model using generalized linear models with a Gamma family and log link. We fit four models to characterize 1) the trend in biomass (or energy use) over time and 2) whether this trend deviates from the trend expected given only changes in abundance:

1. `biomass ~ year * source`, in which "source" refers to being either the "observed" or "null model" value. This model fits a slope and intercept for the observed trend biomass over time, and a separate slope and intercept for the trend drawn from the null model.
2. `biomass ~ year + source`. This model fits a separate intercept, but not slope, for the null model.
3. `biomass ~ year`. This model fits a temporal trend, but does not fit separate trends for the observed and null data.
4. `biomass ~ 1`. The intercept-only model describes no directional change over time for either the observed or null data.

We selected the best-fitting model using AICc. In instances where multiple models had AICc scores within two AICc units of each other, we selected the simplest model within two units of the best score.

For each route's best-fitting model, we extracted the predicted values for the first (usually 1988) and last (usually 2018) year sampled, for both the observed and null trajectories. We calculated the magnitude of change over time as the ratio of the last (2018) to the first (1988) value.

### Relating change in the ISD to decoupling between abundance and biomass/energy use

\newpage


# Results

This analysis revealed evidence of qualitatively different continent-level patterns in the dynamics of biomass, energy, and abundance. Of the 739 routes in this analysis, approximately 70% (500/739 for biomass, and 509/739 for energy use) were best-described using a model incorporating a temporal trend in abundance and/or biomass or energy use. For biomass, these temporal trends were evenly balanced between increases and decreases (256 decreasing trends, and 244 increasing trends). For energy use, there was a much greater representation of decreasing trends (329 decreasing trends and 180 increasing trends). Trends driven by abundance, as reflected by the "null" dynamics, were strongly dominated by declines (335 decreases and 165 increases for abundance-driven dynamics in biomass, and 355 decreases and 154 increases for abundance-driven dynamics in energy use). 

These divergent aggregate outcomes in abundance, energy use, and especially biomass occurred due to decoupling in the long-term trends for these different currencies. For a substantial minority of routes (20% of all routes for biomass, and 7% of all routes for energy use), the best-fitting model fit a different long-term trend for biomass or energy use than for the "null", abundance-driven, trend. When this decoupling occurred, it was overwhelmingly dominated by scenarios in which the slope for abundance-driven dynamics was more negative than that for biomass or energy use (*get numbers*). 

Decoupling between the long-term trajectories of abundance and energy use or biomass is, by definition, indicative of some degree of change in the ISD over time. However, there was not a detectable difference in the degree of turnover in the ISD compared between routes that exhibited different dynamics (i.e. no linear temporal trend, a consistent temporal trend for abundance and biomass or energy use, or differing trends for abundance and biomass or energy use).


\newpage


# Discussion

## Biological interpretation of results

While changes in size-based currencies usually scale with abundance, in a substantial minority of instances they do not. Meaning, there has been directional shift in the size structure that changes the outcome for function vs abundance. 

This means we should extrapolate from "abundance" to "function" with some care. 

When these strong size shifts occur, it is also a prompt to dig deeper into what's going on in that system. 

When they diverge, it is usually in the direction of less-negative-change. Because abundance is usually decreasing, this is generally partially offsetting the decline in energy use/biomass that would be expected just given abundance. This contrasts with general concerns about size-biased declines disproportionately affecting large species. However, the increase in body size is consistent with other observations specific to BBS, possibly reflecting forests in recovery across North America. 

## Limitations and paths forward

## Conclusions

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, include = T, results = T, message = F, warning = F, eval = T, fig.dim = c(3.5, 2))
library(dplyr)
library(drake)
library(multipanelfigure)
library(ggplot2)
theme_set(theme_bw())

## Set up the cache and config
db <- DBI::dbConnect(RSQLite::SQLite(), here::here("analyses", "caches", "all_hasty_toy.sqlite"))
cache <- storr::storr_dbi("datatable", "keystable", db)
cache$del(key = "lock", namespace = "session")


loadd(all_preds, cache=cache)
loadd(all_aics, cache=cache)

winning_aics <- all_aics %>%
  filter(model_family == "Gamma") %>%
  group_by(matssname, model_family) %>%
  mutate(minAICc = min(model_AICc)) %>%
  mutate(deltaAICc = minAICc - model_AICc)  %>%
  mutate(exp_deltas = exp(.5 * deltaAICc)) %>%
  mutate(denom = sum(exp_deltas)) %>%
  mutate(aicc_wt = exp_deltas/ denom) %>%
  arrange(desc(aicc_wt)) %>%
  mutate(rank =row_number()) %>%
  ungroup() %>%
  arrange(matssname, model_family, rank)

delta_2 <- winning_aics %>% filter(deltaAICc > -2) %>%
  filter(model_family == "Gamma") %>%
  group_by(matssname, model_family) %>%
  arrange(modelcomplexity) %>%
  mutate(rank = row_number()) %>%
  filter(rank == 1) %>%
  ungroup()


winning_fits <- delta_2 %>%
  left_join(all_preds) 
```

# Biomasss

## Model outcomes

Overall proportion of routes with winning models:

```{r, results =T}

winning_fits %>% group_by(model_family, model_formula) %>% tally() %>%
  mutate(prop = n / sum(n))

```

Of models with slope term, the proportion for which abundance and biomass are increasing:

```{r}
slope_winning_fits <- winning_fits %>%
  filter(modelcomplexity > 1)

interaction_winning_fits <- winning_fits %>%
  filter(modelcomplexity > 2)

slope_winning_fits %>%
  mutate(abundance_increasing = ratio_sim > 1) %>%
  group_by(abundance_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))


slope_winning_fits %>%
  mutate(biomass_increasing = ratio_real > 1) %>%
  group_by(biomass_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))
```


Restricted to models with an *interaction*:

```{r}
interaction_winning_fits %>%
  mutate(abundance_increasing = ratio_sim > 1) %>%
  group_by(abundance_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))


interaction_winning_fits %>%
  mutate(biomass_increasing = ratio_real > 1) %>%
  group_by(biomass_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))

```

## Direction and magnitude of slopes

```{r}
ggplot(slope_winning_fits, aes(ratio_sim)) + geom_histogram() + scale_x_log10() + geom_vline(xintercept = 1) + ggtitle("Abundance-driven (null model) slope")


ggplot(slope_winning_fits, aes(ratio_real)) + geom_histogram() + scale_x_log10() + geom_vline(xintercept = 1) + ggtitle("Observed slope")

```

## Direction of decoupling

```{r, fig.dim= c(4,4)}

interaction_all_fits <- all_preds %>% group_by_all() %>% filter( grepl( "* source",model_formula), model_family == "Gamma") %>% mutate(plus = substr(model_formula, 12,12) == "+") %>% filter(!plus) %>% ungroup() %>%
  left_join(select(winning_fits, matssname, model_formula) %>% rename(winning_formula = model_formula))

ggplot(interaction_all_fits, aes(ratio_sim, ratio_real)) + geom_point(alpha = .2) + geom_point(data = filter(interaction_all_fits, winning_formula != "1"), aes(color = winning_formula), alpha = .5) + scale_y_log10() + scale_x_log10() + scale_color_viridis_d(end = .8) + theme(legend.position = "bottom") + geom_abline(intercept = 0, slope = 1) + geom_vline(xintercept = 1) + geom_hline(yintercept = 1)
 
```
\newpage
# Energy use 
```{r}
loadd(all_preds_energy, cache=cache)
loadd(all_aics_energy, cache=cache)

winning_aics_energy <- all_aics_energy %>%
  filter(model_family == "Gamma") %>%
  group_by(matssname, model_family) %>%
  mutate(minAICc = min(model_AICc)) %>%
  mutate(deltaAICc = minAICc - model_AICc)  %>%
  mutate(exp_deltas = exp(.5 * deltaAICc)) %>%
  mutate(denom = sum(exp_deltas)) %>%
  mutate(aicc_wt = exp_deltas/ denom) %>%
  arrange(desc(aicc_wt)) %>%
  mutate(rank =row_number()) %>%
  ungroup() %>%
  arrange(matssname, model_family, rank)

delta_2_energy <- winning_aics_energy %>% filter(deltaAICc > -2) %>%
  filter(model_family == "Gamma") %>%
  group_by(matssname, model_family) %>%
  arrange(modelcomplexity) %>%
  mutate(rank = row_number()) %>%
  filter(rank == 1) %>%
  ungroup()


winning_fits_energy <- delta_2_energy %>%
  left_join(all_preds_energy) 
```


## Model outcomes

Overall proportion of routes with winning models:

```{r, results =T}

winning_fits_energy %>% group_by(model_family, model_formula) %>% tally() %>%
  mutate(prop = n / sum(n))

```

Of models with slope term, the proportion for which abundance and biomass are increasing:

```{r}
slope_winning_fits_energy <- winning_fits_energy %>%
  filter(modelcomplexity > 1)

interaction_winning_fits_energy <- winning_fits_energy %>%
  filter(modelcomplexity > 2)

slope_winning_fits_energy %>%
  mutate(abundance_increasing = ratio_sim > 1) %>%
  group_by(abundance_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))


slope_winning_fits_energy %>%
  mutate(energy_increasing = ratio_real > 1) %>%
  group_by(energy_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))
```


Restricted to models with an *interaction*:

```{r}
interaction_winning_fits_energy %>%
  mutate(abundance_increasing = ratio_sim > 1) %>%
  group_by(abundance_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))


interaction_winning_fits_energy %>%
  mutate(energy_increasing = ratio_real > 1) %>%
  group_by(energy_increasing) %>%
  tally() %>%
  mutate(prop = n / sum(n))

```

## Direction and magnitude of slopes

```{r}
ggplot(slope_winning_fits_energy, aes(ratio_sim)) + geom_histogram() + scale_x_log10() + geom_vline(xintercept = 1) + ggtitle("Abundance-driven (null model) slope")


ggplot(slope_winning_fits_energy, aes(ratio_real)) + geom_histogram() + scale_x_log10() + geom_vline(xintercept = 1) + ggtitle("Observed slope")

```

## Direction of decoupling

```{r, fig.dim= c(4,4)}

interaction_all_fits_energy <- all_preds_energy %>% group_by_all() %>% filter( grepl( "* source",model_formula), model_family == "Gamma") %>% mutate(plus = substr(model_formula, 12,12) == "+") %>% filter(!plus) %>% ungroup() %>%
  left_join(select(winning_fits_energy, matssname, model_formula) %>% rename(winning_formula = model_formula))

ggplot(interaction_all_fits_energy, aes(ratio_sim, ratio_real)) + geom_point(alpha = .2) + geom_point(data = filter(interaction_all_fits_energy, winning_formula != "1"), aes(color = winning_formula), alpha = .5) + scale_y_log10() + scale_x_log10() + scale_color_viridis_d(end = .8) + theme(legend.position = "bottom") + geom_abline(intercept = 0, slope = 1) + geom_vline(xintercept = 1) + geom_hline(yintercept = 1)
 
```

## ISD overlap

```{r}

loadd(all_isd_compares, cache =cache)

winning_fits <- winning_fits %>% left_join(all_isd_compares)

ggplot(winning_fits, aes(real_overlap, color = model_formula)) + geom_histogram() + facet_wrap(vars(model_formula), scales = 'free_y', ncol = 1)

isd_glm <- glm(real_overlap ~ model_formula, family = "binomial", data = winning_fits)
# 
# AIC(isd_glm)
# AIC(glm(real_overlap ~ 1, family = "binomial", data = winning_fits))

glm_cor <- cor(predict(isd_glm, type = "response"), isd_glm$model[,1]) ^ 2
```

R2 of binomial GLM `overlap ~ model_formula` (which does not beat a `overlap ~ 1` via AIC, FYI)

```{r}
glm_cor
```

# Goodness of fit of models

```{r}

ggplot(winning_fits, aes(model_cor_squared)) + geom_histogram() + facet_wrap(vars(model_formula), scales = "free_y")

ggplot(winning_fits_energy, aes(model_cor_squared)) + geom_histogram() + facet_wrap(vars(model_formula), scales = "free_y")

```



\newpage
# References
